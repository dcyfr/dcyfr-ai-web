name: Test OIDC Setup
on:
  workflow_dispatch:
  
permissions:
  contents: read
  id-token: write

env:
  NODE_VERSION: '20'
  NPM_CONFIG_PROVENANCE: true

jobs:
  test-oidc:
    name: Test Trusted Publisher OIDC
    runs-on: ubuntu-latest
    environment: production
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup Node.js with npm registry
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          registry-url: 'https://registry.npmjs.org'
      
      - name: Verify OIDC token availability
        run: |
          echo "ğŸ” Checking OIDC environment for Trusted Publisher:"
          if [ -n "${ACTIONS_ID_TOKEN_REQUEST_TOKEN}" ] && [ -n "${ACTIONS_ID_TOKEN_REQUEST_URL}" ]; then
            echo "âœ… OIDC token request environment available"
            echo "âœ… Trusted Publisher authentication will be used"
            echo "   - Token length: ${#ACTIONS_ID_TOKEN_REQUEST_TOKEN}"
            echo "   - Request URL: $ACTIONS_ID_TOKEN_REQUEST_URL"
          else
            echo "âŒ OIDC environment not fully available"
            echo "   - ACTIONS_ID_TOKEN_REQUEST_TOKEN: ${ACTIONS_ID_TOKEN_REQUEST_TOKEN:-'not set'}"
            echo "   - ACTIONS_ID_TOKEN_REQUEST_URL: ${ACTIONS_ID_TOKEN_REQUEST_URL:-'not set'}"
            exit 1
          fi
          
      - name: Test npm authentication (dry run)
        run: |
          echo "ğŸ§ª Testing npm authentication (without publishing):"
          npm whoami --registry https://registry.npmjs.org || echo "Expected: npm authentication via OIDC will happen during actual publish"
          
          echo "ğŸ“¦ Package information:"
          npm view @dcyfr/ai-web version --registry https://registry.npmjs.org
          
          echo "ğŸ” Verifying npm provenance support:"
          npm --version
          if npm --version | grep -E '^(9\.[5-9]|[1-9][0-9])' > /dev/null; then
            echo "âœ… npm version supports provenance"
          else
            echo "âš ï¸ npm version may not support provenance"
          fi
          
      - name: Verify package configuration
        run: |
          echo "ğŸ“‹ Package.json verification:"
          echo "  Name: $(jq -r '.name' package.json)"
          echo "  Version: $(jq -r '.version' package.json)"
          echo "  Repository: $(jq -r '.repository.url' package.json)"
          
          echo "ğŸ·ï¸ Checking release script:"
          jq -r '.scripts.release // "not found"' package.json
          
      - name: Summary
        run: |
          echo "ğŸ¯ OIDC Verification Summary:"
          echo "âœ… GitHub OIDC environment configured"
          echo "âœ… Node.js and npm setup complete"
          echo "âœ… Package configuration verified"
          echo "âœ… Ready for Trusted Publisher authentication"
          echo ""
          echo "ğŸš€ Next: Test actual publication with changeset"